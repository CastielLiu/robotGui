# 基于UDP的远程服务器服务端
    负责客户端间数据转发

## 基本工作流程
### 1. 该服务器包含三个基本线程， N个数据转发线程(N代表成功注册的用户个数)
#### ① 状态信息打印线程 
    定时向终端打印服务器状态信息，为了防止远程终端长时间休眠导致程序中断，若使用后台运行则不会出现此问题。

#### ② 客户端心跳检测线程 
定时循环检测所有客户端心跳状况：
- 若客户端心跳轻度超时，则将其连接状态复位（不可直接删除用户，防止转发线程正在使用而出错），然后该客户端的转发线程自动退出并删除客户
- 若客户端心跳重度超时，表明为转发线程未能自动删除掉该客户端，手动删除客户端
注： 删除用户A前应判断其是否有正在通话的用户B，如果有，则应将B中与A相关的信息复位，以通知B，A已经离线

#### ③ 监听客户端注册信息线程 
- 监听所有信息，过滤用户注册信息
- 防止用户重复登录，若用户已存在，应答重复登录，<目前缺少强制登录功能(挤掉已登录用户)，可在请求注册字段中增加强制登录字段>
- 创建新的socket为客户端分配端口号，并将端口号反馈给客户端 (客户端需要向新的端口号发送确认注册信息)
- 创建新线程监听客户端确认注册信息、退出登录信息、转发信息、等

#### ④ N个数据转发线程 
- 接收新客户端确认注册消息，反馈注册成功信号
- 接收客户端心跳包，更新客户心跳时间，然后回发心跳包给客户端.<目前缺少加锁机制，多线程同时读写上次心跳时间>
- 客户A请求呼叫客户B消息转发与处理
- 请求通话中断信息转发与处理

### 2. 客户端注册流程
① 向服务器注册端口发送请求注册消息消息包，等待服务器回应
② 解析服务器分配的新端口号，并向新端口号发送确认注册消息包，等待服务器回应
③ 服务器回应，i.注册成功 ii. 注册失败 iii.重复注册
④ 注册成功后，定时1s循环向服务器发送心跳包
⑤ 接收服务器心跳包，当服务器心跳超时后认为服务器离线，或网络掉线，自动退出注册

### 3. 客户端A与客户端B建立通话流程
A客户端向服务器发起与B的通话请求;
if(客户端B不在线):
    向A反馈B不在线；
else if(客户端B正在和其他用户通话):
    向A反馈B正忙;
else:
    转发A的请求连接信息到客户端B;

if(客户端B接受A的连接请求):
    服务器更新两客户信息，标记两用户正在通话；
    将客户端B的接受信息转发给客户端A;
    双方开始信息交互;
else if(拒接):
    将客户端B的拒绝信息转发给客户端A，A放弃呼叫;

if(客户端A请求中止通话):
    服务器转发该信息到客户端B，并AB双方之间的正在通话标志删除(即删除A中B的ID,以及B中A的ID);
    客户端B收到请求停止通话指令后自主停止所有发送并中断连接

### 4. 客户端退出注册流程
① 如果有当前通话，中断所有消息发送，发送请求断开通话指令
② 发送退出注册指令

### 5. 通讯数据包结构
通讯数据包包括两部分，数据包头+数据
#### 5.1 数据包头
```
typedef struct TransPack 
{
    uint8_t head[2];     //数据头 0x66 0xCC
    uint16_t length;     //数据字节数
    uint8_t type;        //数据包类型
    uint8_t checkNum;    //数据校验码
    uint16_t senderId;   //数据包发送方ID
    uint16_t receiverId; //数据接收方ID， 0表示服务器
    uint16_t seq;        //数据包序号，用于掉帧检测
} transPack_t;
```
#### 5.2 数据包类型
```
enum dataType
{
    PkgType_NoneType        = 0,

    //客户端注册相关消息类型
    PkgType_RegisterOK      = 1, //注册成功(服务器发往客户端)
    PkgType_RegisterFail    = 2, //注册失败(服务器发往客户端)
    PkgType_RequestRegister = 3, //请求注册到服务器
    PkgType_ResponseRegister= 4, //回应客户端请求(包含服务端服务端口号)
    PkgType_repeatLogin     = 5, //重复登录
    PkgType_LogOut          = 6, //退出登陆

    //客户端连接请求相关消息类型
    PkgType_RequestConnect  = 20, //请求连接
    PkgType_AcceptConnect   = 21, //接收连接
    PkgType_RefuseConnect   = 22, //拒绝连接
    PkgType_DisConnect      = 23, //挂断连接
    PkgType_CalledOffline   = 24, // 被叫不在线
    PkgType_CalledBusy      = 25, //被叫忙

    //心跳包消息类型
    PkgType_HeartBeat       = 50, //心跳包

    //实时传输相关消息类型
    PkgType_Video           = 81, //视频消息
    PkgType_Audio           = 82, //语音
    PkgType_BoilogicalRadar = 83, //生物雷达

    //远程控制相关消息类型
    PkgType_ControlCmd      = 101, //机器人控制指令
    PkgType_RobotState      = 102, //机器人状态反馈
};
```

#### 5.3 语音包  <数据包头 + 语音>
* 采样频率 sampleRate(8000), HZ
* 通道个数 channelCount(1),
* 采样大小 sampleSize(16),   bits

#### 5.4 视频包  <数据包头 + 图像>
* 图片格式 .jpg

#### 5.5 机器人控制指令包 <数据包头 + 控制指令>

其中控制指令结构如下
```
typedef struct ControlCmd
{
    int8_t xSpeed; //前进后退的速度
    int8_t zSpeed; //左右旋转的速度
}controlCmd_t;
```




如果在gedit中打开文件发现中文乱码，可在终端输入下面的指令，然后重启gedit即可
```
gsettings set org.gnome.gedit.preferences.encodings candidate-encodings "['GB18030', 'GB2312', 'GBK', 'UTF-8', 'BIG5', 'CURRENT', 'UTF-16']"
```

